# Operating Rules

Repository operating rules for engineering changes in `branch-review`.

## 1) Branching and scope

1. Start from updated main and create branch via wrapper:
   - `bun run flow:branch -- <type/short-name>`
2. Branches for reviews should use `review/*` prefix.
3. Keep one primary concern per PR.
4. Target PR size: `<= 300` net LOC when possible (excluding lockfiles/snapshots).

## 2) Mandatory CLI flow (commit/PR/merge)

Use project wrappers (do not bypass):

1. Stage files: `git add <files>`
2. Commit: `bun run flow:commit -- -m "type(scope): message"`
3. Pre-PR gate: `bun run flow:prepr`
4. Push: `git push -u origin <branch>`
5. PR creation: `bun run flow:pr -- "PR title" "PR body" --base main`
   - Includes automatic post-PR learning pass for skill extraction.
6. Merge: `bun run flow:merge -- <pr-number> [--squash|--merge|--rebase]`

## 3) Validation gates

Minimum gate before opening/merging PR:

- `bun run lint`
- `bun test`
- `bun run flow:prepr` (defaults to `app` typecheck scope)
- Optional CI-parity static checks on changed files:
  - `BR_BIOME_SINCE=origin/main bash scripts/run-biome-check.sh`
  - `BR_DIFF_RANGE=origin/main...HEAD bash scripts/run-ruff-check.sh`

Typecheck scopes:

- `bun run typecheck:app` → app/API/frontend scope.
- `bun run typecheck:mini-services` → `mini-services/reviewctl` scope.
- `bun run typecheck:all` → app + mini-services.

Pre-PR scope override:

- `BR_PREPR_TYPECHECK_SCOPE=app bun run flow:prepr`
- `BR_PREPR_TYPECHECK_SCOPE=mini-services bun run flow:prepr`
- `BR_PREPR_TYPECHECK_SCOPE=all bun run flow:prepr`
- `BR_PREPR_TYPECHECK_SCOPE=none bun run flow:prepr` (explicit skip with trace)

## 4) Artifacts and guardrails

1. Do not include operational artifacts (`_ctx/review_runs/**`) in product PRs.
2. If a run artifact must be committed, use explicit override:
   - `ALLOW_CTX_ARTIFACTS=1 bun run flow:commit -- -m "..."`
3. Keep generated and runtime files out of staged changes unless required by task.
4. Skills learned from PR decisions are stored under `skills/learned/**` and are allowed artifacts when intentionally generated by post-PR learning.

## 5) Review and merge

1. Wait for PR checks to pass.
2. Address feedback in small commits.
3. Use PR comments wrapper to track/resolve review feedback:
   - `bun run flow:pr-comments -- review`
   - `bun run flow:pr-comments -- reply --comment-id <id> --body "..."`
4. Merge via CLI wrapper with deterministic mode.
5. Sync local main after merge.

## 6) Error and observability standards

1. Hooks/scripts must return actionable errors (`what failed` + `how to fix`).
2. Avoid exposing secrets in logs, hook output, or PR text.
3. Keep decisions traceable (plan, checks, and PR notes).

## 7) Cleanup and safety

1. Before deleting branches, verify diff vs `origin/main`.
2. Keep non-merged work in branch or stash with descriptive message.
3. Prefer reversible changes; avoid broad refactors without explicit approval.

## Related docs

- `docs/cli-flow.md`
- `docs/typecheck-scopes.md`
- `docs/plans/operating-model-improvement-plan-2026-02-26.md`
- `AGENTS.md`
